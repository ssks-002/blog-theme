{"componentChunkName":"component---src-templates-tag-js","path":"/tag/kurisuta/","result":{"data":{"ghostTag":{"slug":"kurisuta","name":"クリスタ","visibility":"public","feature_image":null,"description":null,"meta_title":null,"meta_description":null,"accent_color":null,"postCount":1},"allGhostPost":{"edges":[{"node":{"id":"Ghost__Post__692dbf382ba9e10001ff15ad","title":"彩度合成モードはなにを合成しているのか？","slug":"08","featured":false,"feature_image":"https://ghostmedia.ssks-ss.com/content/images/2025/12/----------2025-12-02-022020.jpg","excerpt":"背景\n\n\nClipStudioやphotoshopには彩度合成モードがあるが　公式ガイドやらTipsやらhtmlベタ打ちのサイトを参照しても基本的な説明は\n\n\n\n\n\n下のレイヤーの輝度と色相を維持したまま、上のレイヤーの彩度にします。\n\n\n\nといった文言もしくは説明自体がなく　具体的な計算式が出てこない\n\n\nこの記述から素直に推測できるのはHSL色空間上の輝度　色相　彩度を用いて処理する方法だが\n\n実際に試すと正しくないとわかる\n\n\n\n\n\n基本色\n合成色\n結果色\n\n\n\n\n(0,50,50)\n(0,95,50)\n(0,100,57)\n\n\n(0,50,50)\n(0,80,50)\n(0,91,56)\n\n\n(0,50,50)\n(0,10,50)\n(0,12,42)\n\n\n(0,50,50)\n(0,0,50)\n(0,0,40)\n\n\n(0,50,50)\n(0,25,50)\n(0,28,45)\n\n\n(0,50,50)\n(0,100,50)\n(0,100,57)\n\n\n\n\n\n(H:色相[°], S:彩度[％], L:輝度[％])\n\n\n一方phothoshopについての説明だが　ここにあるようにRGB値の最","custom_excerpt":null,"visibility":"public","created_at_pretty":"01 December, 2025","published_at_pretty":"03 December, 2025","updated_at_pretty":"04 December, 2025","created_at":"2025-12-02T01:15:52.000+09:00","published_at":"2025-12-03T22:44:20.000+09:00","updated_at":"2025-12-04T18:21:11.000+09:00","meta_title":null,"meta_description":null,"og_description":null,"og_image":null,"og_title":null,"twitter_description":null,"twitter_image":null,"twitter_title":null,"authors":[{"name":"ssks","slug":"ssks","bio":"平素よりお世話になっております","profile_image":"https://ghostmedia.ssks-ss.com/content/images/2023/12/----------2023-11-20-004315-1.jpg","twitter":"@Sn50Tin","facebook":null,"website":"https://www.pixiv.net/users/25391430,https://www.nicovideo.jp/user/31837529"}],"primary_author":{"name":"ssks","slug":"ssks","bio":"平素よりお世話になっております","profile_image":"https://ghostmedia.ssks-ss.com/content/images/2023/12/----------2023-11-20-004315-1.jpg","twitter":"@Sn50Tin","facebook":null,"website":"https://www.pixiv.net/users/25391430,https://www.nicovideo.jp/user/31837529"},"primary_tag":{"name":"技術","slug":"tech","description":null,"feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"},"tags":[{"name":"技術","slug":"tech","description":null,"feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"},{"name":"彩度","slug":"cai-du","description":null,"feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"},{"name":"クリスタ","slug":"kurisuta","description":null,"feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"},{"name":"合成モード","slug":"he-cheng-modo","description":null,"feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"}],"plaintext":"背景\n\n\nClipStudioやphotoshopには彩度合成モードがあるが　公式ガイドやらTipsやらhtmlベタ打ちのサイトを参照しても基本的な説明は\n\n\n\n\n\n下のレイヤーの輝度と色相を維持したまま、上のレイヤーの彩度にします。\n\n\n\nといった文言もしくは説明自体がなく　具体的な計算式が出てこない\n\n\nこの記述から素直に推測できるのはHSL色空間上の輝度　色相　彩度を用いて処理する方法だが\n\n実際に試すと正しくないとわかる\n\n\n\n\n\n基本色\n合成色\n結果色\n\n\n\n\n(0,50,50)\n(0,95,50)\n(0,100,57)\n\n\n(0,50,50)\n(0,80,50)\n(0,91,56)\n\n\n(0,50,50)\n(0,10,50)\n(0,12,42)\n\n\n(0,50,50)\n(0,0,50)\n(0,0,40)\n\n\n(0,50,50)\n(0,25,50)\n(0,28,45)\n\n\n(0,50,50)\n(0,100,50)\n(0,100,57)\n\n\n\n\n\n(H:色相[°], S:彩度[％], L:輝度[％])\n\n\n一方phothoshopについての説明だが　ここにあるようにRGB値の最大値と最小値の差を最大値で割った彩度を用いるのも（非線形で扱いにくそうなので）おそらく正しくない\n\n\nどのパラメータを合成しているか気になったのでこの計算を推定した（=合成を再現した）\n\n\nサンプルデータ等はClipStudioで取得\n\n\n\n結論\n\n\n彩度合成は以下の3つのルールにより計算される\n\n\n・彩度合成モードは一度RGB色空間からYCbCr空間へ線形変換を行い輝度であるY値と、独自に定義されかつ表示されないパラメータである色相と彩度の計3つのパラメータを用いている・彩度合成モードは下のレイヤーのÝである輝度、CbCrから導出された色相を保持し、上のレイヤーのCbCrからから導出された彩度をそのまま結果色として出力する・ただし、下のレイヤーによって指定された色相と輝度からとりうる彩度の最大値が上のレイヤーから導出された彩度を下回った場合、結果色の彩度は下のレイヤーによって指定されたとりうる彩度の最大値をとる\n\n\n説明\n\n\nひとつずつ見ていく\n\n\n・彩度合成モードは一度RGB色空間からYCbCr色空間へ線形変換を行った上で、輝度であるY値と、独自に定義されかつ表示されないパラメータである色相と彩度の計3つのパラメータを用いている\n\n前提としてRGB色空間とYCbCr色空間とその相互変換について\n\n\n・RGB色空間はほとんどのPC上の色表現に用いられる色空間である\n\nRは赤　Gは緑　Bは青とした三要素から色を表現する色空間でありそれぞれの値域は$[0,255]$となる\n\n\n・YCbCr色空間は映像信号などの処理に用いられる色空間である\n\nYは輝度　Cbは青方向色差　Crは赤方向色差とした三要素から色を表現する色空間でありそれぞれの値域は$[0,255] [-127.5,127.5] [-127.5,127.5]$となる（ただし実際の信号処理においては符号化により$[0,255]$となる）\n\n\n・RGBからYCbCrへの変換は特定の係数行列をかけて線形的に行われる　逆変換も同様\n\nその変換式は以下で定義される\n\n\n$$\n\\begin{pmatrix}\nY \\\\\nCb \\\\\nCr\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0.299 & 0.587 & 0.114 \\\\\n-0.168736 & -0.331264 & 0.5 \\\\\n0.5 & -0.418688 & -0.081312\n\\end{pmatrix}\n\\begin{pmatrix}\nR \\\\\nG \\\\\nB\n\\end{pmatrix} \\\\\\\\\n\\begin{pmatrix}\nR \\\\\nG \\\\\nB\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n1 & 0 & 1.402 \\\\\n1 & -0.344136 & -0.714136 \\\\\n1 & 1.1772 & 0\n\\end{pmatrix}\n\\begin{pmatrix}\nY \\\\\nCb \\\\\nCr\n\\end{pmatrix}\n\n$$\n\n\n\nただしこれはいわゆるITU-R BT.601規格でありこの係数行列は規格により異なることに留意する\n\n\n次に用いられる3つのパラメータ：輝度　彩度　色相について\n\n\nこれらはすべてYCbCr色空間上で定義される\n\n\n輝度について：YCbCr色空間のYの値\n\n実際にRGB画像をYCbCrに変換してYのみをグレースケールで表示すると白黒画像になる\n\nRGB値に人間の色認識に応じた加重平均をとるためヒトの分光視感効率に応じた白黒画像を得られる\n\n\n彩度と色相について：Y-Cb-Crはそれぞれ直交するのでCb-Cr平面に対して極座標表示を行った際の角度を色相とし大きさを彩度とする\n\n大きさゼロ（$Cb=Cr=0$）の時YCbCr空間は輝度のみとなる（上式参照）\n\n\n・彩度合成モードは下のレイヤーのÝである輝度、CbCrから導出された色相を保持し、上のレイヤーのCbCrからから導出された彩度をそのまま結果色として出力する\n\n1つめのルールも含め具体的な計算式を追って確認していく\n\n\nまず下のレイヤーのRGB値$RGB_b$を変換して$Y_b,Cb_b,Cr_b$を得る\n\n\n同様に上のレイヤーのRGB値$RGB_c$を変換して$Y_c,Cb_c,Cr_c$を得る\n\n\n次に結果色の輝度($L$)　色相($H$)　彩度($S$)を計算する\n\n\n輝度と色相は下のレイヤーのものを使うので\n\n\n$$\n\\begin{cases} \nL = Y_b\\\\\nH = arctan\\left(\\dfrac{Cr_b}{Cb_b}\\right)\n\\end{cases} \n$$\n\n\n\n彩度は上のレイヤーのものを使うので\n\n\n$$\nS = \\sqrt{Cb_b^2 + Cr_c^2}\n$$\n\n\n\nこの時結果色の$YC_bC_r$は極座標系を直交座標系に直して\n\n\n$$\n\\begin{cases} \nY = L = Y_b\\\\\nC_b = Scos(H)\\\\\nC_r = Ssin(H)\n\\end{cases} \n$$\n\n\n\nとなる\n\n\nこれをRGBへ逆変換すると結果色$RGB_r$が得られる　ということ\n\n\n・ただし、下のレイヤーによって指定された色相と輝度からとりうる彩度最大値が上のレイヤーから導出された彩度を下回った場合、結果色の彩度は下のレイヤーによって指定されたとりうる彩度の最大値をとる\n\nこれが一番めんどくさいルール\n\n\n先ほどの計算では\n\n$$\n\nRGB \\to YCbCr \\to RGB\n\n$$\n\nとして結果色を求めるが　この$YCbCr \\to RGB$の変換\n\n\n$$\n\\begin{cases} \nR=Y+1.402C_r\\\\\nG=Y−0.344136C_b−0.714136C_r\\\\\nB=Y+1.772C_b\n\\end{cases} \n$$\n\n\n\nの際にRGBの値域から外れることがある（飽和する）\n\n\n実際には彩度を最大限維持するためにとることのできる彩度の最大値をとっているということ\n\n\nつまりRGBの値域は$[0,255]$であるため\n\n\n$$\n0≤R≤255,0≤G≤255,0≤B≤255\n$$\n\n\n\nを満たす必要がある\n\n上の式を当てはめて輝度$Y$　彩度$S$　色相$H$を用いて整理するが\n\n$S = \\sqrt{Cb_b^2 + Cr_c^2}≥0$であることも考慮すれば\n\n\n$$\n0≤S≤\\dfrac{255-Y}{1.402sin(H)}\\\\\n0≤S≤\\dfrac{255-Y}{-0.344136cos(H)-0.714136sin(H)}\\\\\n0≤S≤\\dfrac{255-Y}{1.772cos(H)}\n$$\n\n\n\nとなるのでこのうちの最大値と上のレイヤの彩度$S$のどちらか小さい方を選ぶということ\n\n\n\n実際に逐次計算してみる\n\n\n以下の組み合わせで結果色を計算から求めてみる\n\n\n\n\n\n基本色($RGB_b$)\n合成色($RGB_c$)\n結果色($RGB_r$)\n\n\n\n\n(80,74,48)\n(239,223,143)\n(93,76,0)\n\n\n\n\n\nここでの表記は(R, G, B)とした\n\n\n計算がめんどくさい上に出力結果が整数で丸められるので有効数字は4ケタとする\n\n\n用いるパラメータである輝度($L$)彩度($S$)色相($H$)を求める\n\n\n\n終わり\n\n\nここまでの話を理解できれば他の色相や輝度の合成モードは結果色が上下レイヤーのどのパラメータを選び取るかの違いでしかないことがわかる\n\n\nまたグリザイユ画法で使われるカラー合成は上のレイヤーの色相と彩度を保持するとのこと　つまりグリザイユ画法は白黒の絵(=Y値画像)にカラー合成でCbCr平面上の色相と彩度を合成しているということがわかる\n\n\nさらに画像のY値化（輝度化）には色相や彩度やカラー合成モードで彩度ゼロの色調補正レイヤーを上に掛けるだけで行えることがわかる　これは彩度ゼロ=色相もゼロ（大きさゼロの極座標系では角度の定義ができない）となるためである\n\n\nなぜドキュメントに計算式が記載されないかもわかった　四則演算のみで記述できない上に前提知識が必要で実用上知る必要がないため\n\n\n一方で問題は表示されない数字を使用しているということ　ClipStudioではHSLやHSV表示できるが合成モードの名前の印象とは違いそれぞれの色空間での値自体を保持するわけではないので直感に反するかもしれない\n\nそもそも合成モードのリストの一番下にあることから実用性があまりないことを示唆しているが\n\n\nとはいえここまでの話は実際の挙動から推測した解釈なので合っていない可能性も普通にある　調べても出てこないので答え合わせもできない\n\n実際に関数を組んでみると誤差±1くらいにはなるので再現性は高いと思うが誤差の由来はよくわからない\n\nおそらくガンマ補正か小数点以下の切り捨て処理関係だと思われるが…\n\n\n\n色空間や画像処理や信号処理を調べるとデジタルイラストやデジタルモニタを用いた作業ひいては撮影や画像解析で意識すべき点がわかるのが楽しかった\n\n編集ソフトなどのよくわからない環境設定の項目は大抵こういう話に関係している\n\nDTPなどにも関係するので知識を持っておくといいかもしれない\n\n\nこういう試行錯誤はやりたいことに対してどのような手法を取るかを考える上結構重要だなと思う\n\n\nおわり\n","html":"<h1 id=\"%E8%83%8C%E6%99%AF\">背景</h1>\n<p>ClipStudioやphotoshopには彩度合成モードがあるが　<a href=\"https://help.clip-studio.com/ja-jp/manual_jp/180_layers/%E5%90%88%E6%88%90%E3%83%A2%E3%83%BC%E3%83%89%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B.htm?ref=ghost.ssks-ss.com\">公式ガイド</a>やら<a href=\"https://tips.clip-studio.com/ja-jp/articles/4163?ref=ghost.ssks-ss.com#f556cd60\">Tips</a>やら<a href=\"https://www.fbs.osaka-u.ac.jp/labs/ishijima/Photoshop-01.html?ref=ghost.ssks-ss.com\">htmlベタ打ちのサイト</a>を参照しても基本的な説明は</p>\n<blockquote>\n<p>下のレイヤーの輝度と色相を維持したまま、上のレイヤーの彩度にします。</p>\n</blockquote>\n<p>といった文言もしくは説明自体がなく　具体的な計算式が出てこない</p>\n<p>この記述から素直に推測できるのはHSL色空間上の輝度　色相　彩度を用いて処理する方法だが<br>\n実際に試すと正しくないとわかる</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">基本色</th>\n<th style=\"text-align:center\">合成色</th>\n<th style=\"text-align:center\">結果色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">(0,50,50)  <div style=\"width:75%; height:10px; background:hsl(0, 50%, 50%); margin:0 auto;\" 　></div></td>\n<td style=\"text-align:center\">(0,95,50)  <div style=\"width:75%; height:10px; background:hsl(0, 95%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,100,57)<div style=\"width:75%; height:10px; background:hsl(0, 100%, 57%); margin:0 auto;\"></div></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">(0,50,50)<div style=\"width:75%; height:10px; background:hsl(0, 50%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,80,50)<div style=\"width:75%; height:10px; background:hsl(0, 80%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,91,56)<div style=\"width:75%; height:10px; background:hsl(0, 91%, 56%); margin:0 auto;\"></div></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">(0,50,50)<div style=\"width:75%; height:10px; background:hsl(0, 50%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,10,50)<div style=\"width:75%; height:10px; background:hsl(0, 10%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,12,42)<div style=\"width:75%; height:10px; background:hsl(0, 12%, 42%); margin:0 auto;\"></div></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">(0,50,50)<div style=\"width:75%; height:10px; background:hsl(0, 50%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,0,50)<div style=\"width:75%; height:10px; background:hsl(0, 0%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,0,40)<div style=\"width:75%; height:10px; background:hsl(0, 0%, 40%); margin:0 auto;\"></div></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">(0,50,50)<div style=\"width:75%; height:10px; background:hsl(0, 50%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,25,50)<div style=\"width:75%; height:10px; background:hsl(0, 25%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,28,45)<div style=\"width:75%; height:10px; background:hsl(0, 28%, 45%); margin:0 auto;\"></div></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">(0,50,50)<div style=\"width:75%; height:10px; background:hsl(0, 50%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,100,50)<div style=\"width:75%; height:10px; background:hsl(0, 100%, 50%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(0,100,57)<div style=\"width:75%; height:10px; background:hsl(0, 100%, 57%); margin:0 auto;\"></div></td>\n</tr>\n</tbody>\n</table>\n<p>(H:色相[°], S:彩度[％], L:輝度[％])</p>\n<p>一方phothoshopについての説明だが　<a href=\"https://ns.ofo.jp/osakana/cgtips/blendmode.phtml?ref=ghost.ssks-ss.com\">ここ</a>にあるようにRGB値の最大値と最小値の差を最大値で割った彩度を用いるのも（非線形で扱いにくそうなので）おそらく正しくない</p>\n<p>どのパラメータを合成しているか気になったのでこの<strong>計算を推定した（=合成を再現した）</strong></p>\n<p>サンプルデータ等はClipStudioで取得</p>\n<h1 id=\"%E7%B5%90%E8%AB%96\">結論</h1>\n<p>彩度合成は以下の3つのルールにより計算される</p>\n<div class=\"kg-card kg-callout-card kg-callout-card-pink\"><div class=\"kg-callout-text\">・彩度合成モードは一度RGB色空間からYCbCr空間へ線形変換を行い輝度であるY値と、独自に定義されかつ表示されないパラメータである色相と彩度の計3つのパラメータを用いている</div></div><div class=\"kg-card kg-callout-card kg-callout-card-pink\"><div class=\"kg-callout-text\">・彩度合成モードは下のレイヤーのÝである輝度、CbCrから導出された色相を保持し、上のレイヤーのCbCrからから導出された彩度をそのまま結果色として出力する</div></div><div class=\"kg-card kg-callout-card kg-callout-card-pink\"><div class=\"kg-callout-text\">・ただし、下のレイヤーによって指定された色相と輝度からとりうる彩度の最大値が上のレイヤーから導出された彩度を下回った場合、結果色の彩度は下のレイヤーによって指定されたとりうる彩度の最大値をとる</div></div><h1 id=\"%E8%AA%AC%E6%98%8E\">説明</h1>\n<p>ひとつずつ見ていく</p>\n<div class=\"kg-card kg-callout-card kg-callout-card-pink\"><div class=\"kg-callout-text\">・彩度合成モードは一度RGB色空間からYCbCr色空間へ線形変換を行った上で、輝度であるY値と、独自に定義されかつ表示されないパラメータである色相と彩度の計3つのパラメータを用いている</div></div><p>前提としてRGB色空間とYCbCr色空間とその相互変換について</p>\n<p>・RGB色空間はほとんどのPC上の色表現に用いられる色空間である<br>\nRは赤　Gは緑　Bは青とした三要素から色を表現する色空間でありそれぞれの値域は$[0,255]$となる</p>\n<p>・YCbCr色空間は映像信号などの処理に用いられる色空間である<br>\nYは輝度　Cbは青方向色差　Crは赤方向色差とした三要素から色を表現する色空間でありそれぞれの値域は$[0,255] [-127.5,127.5] [-127.5,127.5]$となる（ただし実際の信号処理においては符号化により$[0,255]$となる）</p>\n<p>・RGBからYCbCrへの変換は特定の係数行列をかけて線形的に行われる　逆変換も同様<br>\nその変換式は以下で定義される</p>\n<pre><code>$$\n\\begin{pmatrix}\nY \\\\\nCb \\\\\nCr\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0.299 &amp; 0.587 &amp; 0.114 \\\\\n-0.168736 &amp; -0.331264 &amp; 0.5 \\\\\n0.5 &amp; -0.418688 &amp; -0.081312\n\\end{pmatrix}\n\\begin{pmatrix}\nR \\\\\nG \\\\\nB\n\\end{pmatrix} \\\\\\\\\n\\begin{pmatrix}\nR \\\\\nG \\\\\nB\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n1 &amp; 0 &amp; 1.402 \\\\\n1 &amp; -0.344136 &amp; -0.714136 \\\\\n1 &amp; 1.1772 &amp; 0\n\\end{pmatrix}\n\\begin{pmatrix}\nY \\\\\nCb \\\\\nCr\n\\end{pmatrix}\n\n$$\n</code></pre>\n<p>ただしこれはいわゆるITU-R BT.601規格でありこの係数行列は規格により異なることに留意する</p>\n<p>次に用いられる3つのパラメータ：輝度　彩度　色相について</p>\n<p>これらはすべてYCbCr色空間上で定義される</p>\n<p>輝度について：YCbCr色空間のYの値<br>\n実際にRGB画像をYCbCrに変換してYのみをグレースケールで表示すると白黒画像になる<br>\nRGB値に人間の色認識に応じた加重平均をとるためヒトの分光視感効率に応じた白黒画像を得られる</p>\n<p>彩度と色相について：Y-Cb-Crはそれぞれ直交するのでCb-Cr平面に対して極座標表示を行った際の角度を色相とし大きさを彩度とする<br>\n大きさゼロ（$Cb=Cr=0$）の時YCbCr空間は輝度のみとなる（上式参照）</p>\n<div class=\"kg-card kg-callout-card kg-callout-card-pink\"><div class=\"kg-callout-text\">・彩度合成モードは下のレイヤーのÝである輝度、CbCrから導出された色相を保持し、上のレイヤーのCbCrからから導出された彩度をそのまま結果色として出力する</div></div><p>1つめのルールも含め具体的な計算式を追って確認していく</p>\n<p>まず下のレイヤーのRGB値$RGB_b$を変換して$Y_b,Cb_b,Cr_b$を得る</p>\n<p>同様に上のレイヤーのRGB値$RGB_c$を変換して$Y_c,Cb_c,Cr_c$を得る</p>\n<p>次に結果色の輝度($L$)　色相($H$)　彩度($S$)を計算する</p>\n<p>輝度と色相は下のレイヤーのものを使うので</p>\n<pre><code>$$\n\\begin{cases} \nL = Y_b\\\\\nH = arctan\\left(\\dfrac{Cr_b}{Cb_b}\\right)\n\\end{cases} \n$$\n</code></pre>\n<p>彩度は上のレイヤーのものを使うので</p>\n<pre><code>$$\nS = \\sqrt{Cb_b^2 + Cr_c^2}\n$$\n</code></pre>\n<p>この時結果色の$YC_bC_r$は極座標系を直交座標系に直して</p>\n<pre><code>$$\n\\begin{cases} \nY = L = Y_b\\\\\nC_b = Scos(H)\\\\\nC_r = Ssin(H)\n\\end{cases} \n$$\n</code></pre>\n<p>となる</p>\n<p>これをRGBへ逆変換すると結果色$RGB_r$が得られる　ということ</p>\n<div class=\"kg-card kg-callout-card kg-callout-card-pink\"><div class=\"kg-callout-text\">・ただし、下のレイヤーによって指定された色相と輝度からとりうる彩度最大値が上のレイヤーから導出された彩度を下回った場合、結果色の彩度は下のレイヤーによって指定されたとりうる彩度の最大値をとる</div></div><p>これが一番めんどくさいルール</p>\n<p>先ほどの計算では<br>\n$$<br>\nRGB  \\to YCbCr \\to RGB<br>\n$$<br>\nとして結果色を求めるが　この$YCbCr \\to RGB$の変換</p>\n<pre><code>$$\n\\begin{cases} \nR=Y+1.402C_r\\\\\nG=Y−0.344136C_b−0.714136C_r\\\\\nB=Y+1.772C_b\n\\end{cases} \n$$\n</code></pre>\n<p>の際にRGBの値域から外れることがある（飽和する）</p>\n<p>実際には彩度を最大限維持するためにとることのできる彩度の最大値をとっているということ</p>\n<p>つまりRGBの値域は$[0,255]$であるため</p>\n<pre><code>$$\n0≤R≤255,0≤G≤255,0≤B≤255\n$$\n</code></pre>\n<p>を満たす必要がある<br>\n上の式を当てはめて輝度$Y$　彩度$S$　色相$H$を用いて整理するが<br>\n$S = \\sqrt{Cb_b^2 + Cr_c^2}≥0$であることも考慮すれば</p>\n<pre><code>$$\n0≤S≤\\dfrac{255-Y}{1.402sin(H)}\\\\\n0≤S≤\\dfrac{255-Y}{-0.344136cos(H)-0.714136sin(H)}\\\\\n0≤S≤\\dfrac{255-Y}{1.772cos(H)}\n$$\n</code></pre>\n<p>となるのでこのうちの最大値と上のレイヤの彩度$S$のどちらか小さい方を選ぶということ</p>\n<h2 id=\"%E5%AE%9F%E9%9A%9B%E3%81%AB%E9%80%90%E6%AC%A1%E8%A8%88%E7%AE%97%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\">実際に逐次計算してみる</h2>\n<p>以下の組み合わせで結果色を計算から求めてみる</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">基本色($RGB_b$)</th>\n<th style=\"text-align:center\">合成色($RGB_c$)</th>\n<th style=\"text-align:center\">結果色($RGB_r$)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">(80,74,48)<div style=\"width:75%; height:10px; background:hsl(49, 25%, 25%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(239,223,143)<div style=\"width:75%; height:10px; background:hsl(50, 75%, 75%); margin:0 auto;\"></div></td>\n<td style=\"text-align:center\">(93,76,0)<div style=\"width:75%; height:10px; background:hsl(49, 100%, 18%); margin:0 auto;\"></div></td>\n</tr>\n</tbody>\n</table>\n<p>ここでの表記は(R, G, B)とした</p>\n<p>計算がめんどくさい上に出力結果が整数で丸められるので有効数字は4ケタとする</p>\n<p>用いるパラメータである輝度($L$)彩度($S$)色相($H$)を求める</p>\n<h1 id=\"%E7%B5%82%E3%82%8F%E3%82%8A\">終わり</h1>\n<p>ここまでの話を理解できれば他の色相や輝度の合成モードは結果色が上下レイヤーのどのパラメータを選び取るかの違いでしかないことがわかる</p>\n<p>またグリザイユ画法で使われるカラー合成は上のレイヤーの色相と彩度を保持するとのこと　つまりグリザイユ画法は白黒の絵(=Y値画像)にカラー合成でCbCr平面上の色相と彩度を合成しているということがわかる</p>\n<p>さらに画像のY値化（輝度化）には色相や彩度やカラー合成モードで彩度ゼロの色調補正レイヤーを上に掛けるだけで行えることがわかる　これは彩度ゼロ=色相もゼロ（大きさゼロの極座標系では角度の定義ができない）となるためである</p>\n<p>なぜドキュメントに計算式が記載されないかもわかった　四則演算のみで記述できない上に前提知識が必要で実用上知る必要がないため</p>\n<p>一方で問題は表示されない数字を使用しているということ　ClipStudioではHSLやHSV表示できるが合成モードの名前の印象とは違いそれぞれの色空間での値自体を保持するわけではないので直感に反するかもしれない<br>\nそもそも合成モードのリストの一番下にあることから実用性があまりないことを示唆しているが</p>\n<p>とはいえここまでの話は実際の挙動から推測した解釈なので合っていない可能性も普通にある　調べても出てこないので答え合わせもできない<br>\n実際に関数を組んでみると誤差±1くらいにはなるので再現性は高いと思うが誤差の由来はよくわからない<br>\nおそらくガンマ補正か小数点以下の切り捨て処理関係だと思われるが…</p>\n<hr>\n<p>色空間や画像処理や信号処理を調べるとデジタルイラストやデジタルモニタを用いた作業ひいては撮影や画像解析で意識すべき点がわかるのが楽しかった<br>\n編集ソフトなどのよくわからない環境設定の項目は大抵こういう話に関係している<br>\nDTPなどにも関係するので知識を持っておくといいかもしれない</p>\n<p>こういう試行錯誤はやりたいことに対してどのような手法を取るかを考える上結構重要だなと思う</p>\n<p>おわり</p>\n","url":"https://ghost.ssks-ss.com/08/","canonical_url":null,"uuid":"cd0114c6-d9b6-40e7-a555-92282658463f","page":null,"codeinjection_foot":null,"codeinjection_head":null,"codeinjection_styles":null,"comment_id":"692dbf382ba9e10001ff15ad","reading_time":5}}]}},"pageContext":{"slug":"kurisuta"}},"staticQueryHashes":["1752937443","2358152166","2561578252","2731221146","4145280475"]}